generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id           String                 @id @default(uuid())
  email        String                 @unique
  name         String?
  createdAt    DateTime               @default(now())
  categories   Category[]
  summaries    CreditCardSummary[]
  debts        Debt[]
  institutions FinancialInstitution[]
  products     FinancialProduct[]
  services     Service[]
  serviceBills ServiceBill[]
  transactions Transaction[]
  notes        Note[]
}

model Category {
  id           String        @id @default(uuid())
  name         String
  icon         String?
  categoryType CategoryType  @default(EXPENSE)
  isSystem     Boolean       @default(false)
  userId       String
  user         User          @relation(fields: [userId], references: [id])
  services     Service[]
  transactions Transaction[]
}

model Transaction {
  id                String            @id @default(uuid())
  amount            Decimal
  date              DateTime
  description       String
  status            String            @default("COMPLETED")
  planZ             Boolean           @default(false)
  type              TransactionType
  categoryId        String?
  installmentNumber Int?
  installmentTotal  Int?
  installmentId     String?
  userId            String
  fromProductId     String
  toProductId       String?
  serviceBill       ServiceBill?
  summaryItems      SummaryItem[]
  category          Category?         @relation(fields: [categoryId], references: [id])
  fromProduct       FinancialProduct  @relation("FromProduct", fields: [fromProductId], references: [id])
  toProduct         FinancialProduct? @relation("ToProduct", fields: [toProductId], references: [id])
  user              User              @relation(fields: [userId], references: [id])
}

model Debt {
  id              String    @id @default(uuid())
  name            String
  totalAmount     Decimal
  remainingAmount Decimal
  interestRate    Decimal?
  dueDate         DateTime?
  userId          String
  user            User      @relation(fields: [userId], references: [id])
}

model FinancialInstitution {
  id           String             @id @default(uuid())
  name         String
  type         InstitutionType
  userId       String
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  shareSummary Boolean            @default(false)
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  products     FinancialProduct[]
  summaries    CreditCardSummary[]
  notes        Note[]

  @@unique([userId, name])
}

model FinancialProduct {
  id                 String                @id @default(uuid())
  name               String
  type               ProductType
  currency           Currency              @default(ARS)
  balance            Decimal               @default(0.0)
  closingDay         Int?
  dueDay             Int?
  limit              Decimal?
  limitSinglePayment Decimal?
  limitInstallments  Decimal?
  sharedLimit        Boolean               @default(false)
  unifiedLimit       Boolean               @default(false)
  lastFourDigits     String?
  expirationDate     DateTime?             // Card plastic expiration date
  provider           CardProvider?
  institutionId      String?
  linkedProductId    String?
  userId             String
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  paidSummaries      CreditCardSummary[]   @relation("SummaryPayment")
  summaries          CreditCardSummary[]
  institution        FinancialInstitution? @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  linkedProduct      FinancialProduct?     @relation("LinkedProduct", fields: [linkedProductId], references: [id])
  linkedByProducts   FinancialProduct[]    @relation("LinkedProduct")
  user               User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  paymentRules       ServicePaymentRule[]
  transactionsOrigin Transaction[]         @relation("FromProduct")
  transactionsDest   Transaction[]         @relation("ToProduct")

  @@unique([institutionId, name, currency, userId])
}

model CreditCardSummary {
  id                   String              @id @default(uuid())
  institutionId        String?
  productId            String
  year                 Int
  month                Int
  closingDate          DateTime
  dueDate              DateTime
  totalAmount          Decimal             @default(0.0)
  isClosed             Boolean             @default(false)
  userId               String
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  adjustmentsAmount    Decimal             @default(0.0)
  calculatedAmount     Decimal             @default(0.0)
  paidDate             DateTime?
  paidFromProductId    String?
  paymentTransactionId String?             @unique
  status               SummaryStatus       @default(DRAFT)
  paidFromProduct      FinancialProduct?   @relation("SummaryPayment", fields: [paidFromProductId], references: [id])
  product              FinancialProduct    @relation(fields: [productId], references: [id], onDelete: Cascade)
  institution          FinancialInstitution? @relation(fields: [institutionId], references: [id])
  user                 User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  adjustments          SummaryAdjustment[]
  items                SummaryItem[]

  @@unique([institutionId, productId, year, month])
  @@index([userId, productId])
}

model SummaryItem {
  id             String            @id @default(uuid())
  summaryId      String
  transactionId  String
  amount         Decimal
  isReconciled   Boolean           @default(false)
  hasDiscrepancy Boolean           @default(false)
  note           String?
  summary        CreditCardSummary @relation(fields: [summaryId], references: [id], onDelete: Cascade)
  transaction    Transaction       @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@unique([summaryId, transactionId])
}

model SummaryAdjustment {
  id          String            @id @default(uuid())
  summaryId   String
  type        AdjustmentType
  description String
  amount      Decimal
  createdAt   DateTime          @default(now())
  summary     CreditCardSummary @relation(fields: [summaryId], references: [id], onDelete: Cascade)
}

model ExchangeRate {
  id           String   @id @default(uuid())
  fromCurrency Currency
  toCurrency   Currency
  rate         Decimal
  timestamp    DateTime @default(now())

  @@unique([fromCurrency, toCurrency, timestamp])
  @@index([timestamp])
}

model Service {
  id            String               @id @default(uuid())
  name          String
  defaultAmount Decimal?
  defaultDueDay Int?
  renewalDate   DateTime?
  renewalNote   String?
  categoryId    String
  userId        String
  active        Boolean              @default(true)
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  category      Category             @relation(fields: [categoryId], references: [id])
  user          User                 @relation(fields: [userId], references: [id])
  bills         ServiceBill[]
  paymentRules  ServicePaymentRule[]
}

model ServiceBill {
  id            String       @id @default(uuid())
  serviceId     String
  dueDate       DateTime
  amount        Decimal
  status        BillStatus   @default(PENDING)
  transactionId String?      @unique
  month         Int
  year          Int
  userId        String
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  service       Service      @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  transaction   Transaction? @relation(fields: [transactionId], references: [id])
  user          User         @relation(fields: [userId], references: [id])

  @@unique([serviceId, year, month])
}

model ServicePaymentRule {
  id          String             @id @default(uuid())
  serviceId   String
  productId   String
  benefitType ServiceBenefitType
  value       Decimal
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  product     FinancialProduct   @relation(fields: [productId], references: [id], onDelete: Cascade)
  service     Service            @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([serviceId, productId])
}

enum BillStatus {
  PENDING
  PAID
  SKIPPED
}

enum ServiceBenefitType {
  DISCOUNT
  CASHBACK
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

enum InstitutionType {
  BANK
  WALLET
}

enum ProductType {
  CASH
  SAVINGS_ACCOUNT
  CHECKING_ACCOUNT
  DEBIT_CARD
  CREDIT_CARD
  LOAN
}

enum Currency {
  ARS
  USD
  USDT
  USDC
  BTC
}

enum CategoryType {
  INCOME
  EXPENSE
}

enum CardProvider {
  VISA
  MASTERCARD
  AMEX
  OTHER
}

enum SummaryStatus {
  DRAFT
  CLOSED
  PAID
}

enum AdjustmentType {
  COMMISSION
  TAX
  INTEREST
  INSURANCE
  CREDIT
  OTHER
}

model Note {
  id          String    @id @default(uuid())
  title       String
  content     String?
  color       String    @default("yellow")
  deadline    DateTime?
  isRecurring Boolean   @default(false)
  isCompleted Boolean   @default(false)
  userId      String
  institutionId String?
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  institution FinancialInstitution? @relation(fields: [institutionId], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
}
